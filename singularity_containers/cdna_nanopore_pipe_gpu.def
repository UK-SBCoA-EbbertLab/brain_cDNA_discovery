Bootstrap: docker
From: tensorflow/tensorflow:latest-gpu

%post

	## Make Shell Noninteractive ##
        DEBIAN_FRONTEND=noninteractive
		
	## Install basic packages and get update
        apt-get update && apt-get -y install wget git time lsb-release sudo gnupg curl unzip g++ make rsync vim locales libssl-dev libcurl4-openssl-dev libxml2-dev

        ## Set timezone and language for container ##
        ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime
	
	export LANGUAGE=en_US.UTF-8
	export LANG=en_US.UTF-8
	export LC_ALL=en_US.UTF-8
	sudo locale-gen en_US.UTF-8

	echo 'export LANGUAGE="en_US.UTF8"' >> $SINGULARITY_ENVIRONMENT
	echo 'export LANG="en_US.UTF8"' >> $SINGULARITY_ENVIRONMENT
	echo 'export LC_ALL="en_US.UTF8"' >> $SINGULARITY_ENVIRONMENT

	
    	## Install miniconda ##
	cd /
	wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    	bash Miniconda3-latest-Linux-x86_64.sh -bfp /conda
	export PATH="/conda/bin:$PATH"
    	echo 'export PATH="/conda/bin:$PATH"' >> $SINGULARITY_ENVIRONMENT
	conda config --add channels defaults
	conda config --add channels bioconda
	conda config --add channels conda-forge
	
	## Install Bambu, FLAIR, RSEM, StringTie, GFFread, GFFcompare, STAR, Salmon, SamTools, MiniMap2 ##	
	conda install -c bioconda flair bioconductor-bambu stringtie gffread gffcompare samtools minimap2 pychopper

        ## Install Flair Fusion ##
        cd /
        git clone https://github.com/BrooksLabUCSC/FLAIR-fusion
        echo 'export PATH="/FLAIR_fusion:$PATH"' >> $SINGULARITY_ENVIRONMENT

	## Install guppy basecaller ##
	export PLATFORM=$(lsb_release -cs)
    	wget -O- https://mirror.oxfordnanoportal.com/apt/ont-repo.pub | sudo apt-key add -
	echo "deb http://mirror.oxfordnanoportal.com/apt ${PLATFORM}-stable non-free" | sudo tee /etc/apt/sources.list.d/nanoporetech.sources.list
    	apt-get update
    	apt install -y ont-guppy 

	## Install PycoQC ##
	pip install pycoQC

	## Install MultiQC ##
	pip install multiqc

	## Install RseQC ##
	pip install RSeQC

%test
		
	## Check if installations are on path and/or display their versions ##
    	conda --version
	stringtie --version
	python --version
	pip --version
	guppy_basecaller --version # Guppy
	gffread --version
	which pychopper # Pychopper 
	R --version
	pycoQC --version
	multiqc --version
	bam2fq.py --version # RseQC
	samtools --version
	gffcompare --version
	nvcc --version #Cuda
	
	## Check if bambu R package is working ##
	R --slave -e 'library(BiocManager)'
	R --slave -e 'library(bambu)'
	
	
%labels
	author Bernardo Aguzzoli Heberle
	version v0.0.1

%help
	This is the singularity container used to run the nextflow pipeline found at https://github.com/UK-SBCoA-EbbertLab/cDNA_pipeline. 

	Software included in the container are:

	conda==4.14.0
	pip==21.2.4
	python==3.7.7
	R==4.2.1
	pychopper==2.7.1
	bambu==2.2.0
	RseQC==2.6.4
	pycoQC==2.5.2
	multiqc==1.12
	gffcompare==0.12.7
	guppy==6.3.2
	cuda==11.2.152  (From docker tensorflow/tensorflow latest image pulled on September 1st 2022: sha256:sha256:a34c2420739cd5a7b5662449bc21eb32d3d1c98063726ae2bd7db819cc93d72f)
	samtools==1.10

        NOTE THAT VERSIONS OF THE SOFTWARE INSTALLED WILL CHANGE THROUGH TIME IF YOU BUILD THE IMAGE FROM THE RECIPE FILE.
        TO GET THE ORIGINAL VERSION OF THIS CONTAINER PULL IT FROM THE SINGULARITY LIB WITH THE COMMAND:

	
	For more information about the use of this singularity container access: https://github.com/UK-SBCoA-EbbertLab/cDNA_pipeline

